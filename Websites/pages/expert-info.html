<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>SB Admin 2 - Bootstrap Admin Theme</title>

    <!-- Bootstrap Core CSS -->
    <link href="../vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">

    <!-- MetisMenu CSS -->
    <link href="../vendor/metisMenu/metisMenu.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link href="../dist/css/sb-admin-2.css" rel="stylesheet">

    <!-- Custom Fonts -->
    <link href="../vendor/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">

    <!-- jQuery UI -->
    <link href="../vendor/jquery-ui-1.12.1/jquery-ui.min.css" rel="stylesheet" type="text/css">
    <link href="../vendor/jquery-ui-1.12.1/style.css" rel="stylesheet">

    <!-- MagicSuggest Combobox -->
    <link href="../vendor/MagicSuggest/magicsuggest-min.css" rel="stylesheet">

    <!-- DataTables CSS -->
    <link href="../vendor/datatables/css/jquery.dataTables.min.css" rel="stylesheet">

</head>

<body>

    <div id="object-wrapper">
        <div class="row" style="padding: 0 0 0 15px">
            <div class="col-lg-12">
                <h1 class="page-header">南邮盐城大数据研究院专家基础信息</h1>
            </div>
            <!-- /.col-lg-12 -->

        </div>
        <!-- /.row -->

        <div class="row" style="padding: 0 0 0 15px">
            <div class="col-sm-12" id="ControlPanel">
                <div class="panel panel-info">
                    <div class="panel-heading">专家基础信息</div>
                    <div class="panel-body">
                        <div class="col-sm-3 margin" style="margin-top:10px">
                            <label>姓名：</label>
                            <input class="col-sm-12" type="text" id="name">
                        </div>

                        <div class="col-sm-3 margin" style="margin-top:10px">
                            <label>身份证号:</label>
                            <input class="col-sm-12" type="text" id="code">
                        </div>

                        <div class="col-sm-3 margin" style="margin-top:10px">
                            <label>联系电话:</label>
                            <input class="col-sm-12" type="text" id="phone">
                        </div>

                        <div class="col-sm-3 margin" style="margin-top:10px">
                            <label>电子邮箱:</label>
                            <input class="col-sm-12" type="text" id="email">
                        </div>

                        <div class="col-sm-3 margin" style="margin-top:10px">
                            <label>单位：</label>
                            <div id="unit"></div>
                        </div>

                        <div class="col-sm-3 margin" style="margin-top:10px">
                            <label>职务（职称）：</label>
                            <div id="duty"></div>
                        </div>

                        <div class="col-sm-3 margin" style="margin-top:10px">
                            <label>学历、学位：</label>
                            <div id="education"></div>
                        </div>

                        <div class="col-sm-3 margin" style="margin-top:10px">
                            <label>专业（产业领域）：</label>
                            <div id="domain"></div>
                        </div>

                        <div class="col-sm-3 margin" style="margin-top:10px">
                            <label>操作类型：</label>
                            <div id="operation"></div>
                        </div>

                        <div class="col-sm-9 margin" style="margin-top:10px">
                            <label>备注：</label>
                            <input class="col-sm-12" type="text" id="remark">
                        </div>

                        <div class="col-sm-12 margin" style="margin-top:15px">
                            <!-- <center> -->
                                <button id="RefreshTable" type="button" class="btn btn-info" style="width:10%">刷新列表</button>
                                <button id="Submit" type="button" class="btn btn-primary" style="width:10%">提交</button>
                                <button id="BatchUpload" type="button" class="btn btn-warning" style="width:10%">批量上传</button>
                            <!-- </center> -->
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-sm-12">
                <div class="panel panel-info">
                    <div class="panel-heading">专家基础信息列表</div>
                    <div class="panel-body">
                        <div class="col-sm-12 margin" style="margin-bottom:15px">
                            <button id="multi-select" type="button" class="btn btn-default" style="width:10%">多选</button>
                            <button id="delete" type="button" class="btn btn-danger" style="width:10%">删除</button>
                        </div>

                        <table id="expertList" class="display" cellspacing="0" width="100%">
                            <thead>
                                <tr>
                                    <th>序号</th>
                                    <th>姓名</th>
                                    <th>身份证号</th>
                                    <th>联系电话</th>
                                    <th>电子邮箱</th>
                                    <th>单位</th>
                                    <th>职务（职称）</th>
                                    <th>学历、学位</th>
                                    <th>专业（产业领域）</th>
                                    <th>备注</th>
                                </tr>
                            </thead>
                            <tfoot>
                                <tr>
                                    <th>序号</th>
                                    <th>姓名</th>
                                    <th>身份证号</th>
                                    <th>联系电话</th>
                                    <th>电子邮箱</th>
                                    <th>单位</th>
                                    <th>职务（职称）</th>
                                    <th>学历、学位</th>
                                    <th>专业（产业领域）</th>
                                    <th>备注</th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <!-- /.row -->
    </div>




    <!-- jQuery -->
    <script src="../vendor/jquery/jquery.min.js"></script>
    <script src="../vendor/jquery-ui-1.12.1/jquery-ui.js"></script>

    <!-- Bootstrap Core JavaScript -->
    <script src="../vendor/bootstrap/js/bootstrap.min.js"></script>

    <!-- Metis Menu Plugin JavaScript -->
    <script src="../vendor/metisMenu/metisMenu.min.js"></script>

    <!-- MagicSuggest Combobox -->
    <script src="../vendor/MagicSuggest/magicsuggest.js"></script>

    <!-- Common Configuration -->
    <script src="../js/common.js"></script>

    <!-- Custom Theme JavaScript -->
    <script src="../dist/js/sb-admin-2.js"></script>

    <!-- DataTables JavaScript -->
    <script src="../vendor/datatables/js/jquery.dataTables.js"></script>

    <!-- Load Sign -->
    <script src="../js/spin.min.js"></script>



    <script type="text/javascript">
        var unitCombobox,           //单位下拉框
            dutyCombobox,           //职务下拉框
            educationCombobox,      //学历下拉框
            domainCombobox,         //专业下拉框
            operationCombobox,      //操作类型下拉框
            expertList,             //专家信息列表
            record_id = 0;          //序号

        var isMultisel = false;     //多选按钮激活状态

        var opts = {
              lines: 9                      // The number of lines to draw
            , length: 28                    // The length of each line
            , width: 23                     // The line thickness
            , radius: 37                    // The radius of the inner circle
            , scale: 0.5                    // Scales overall size of the spinner
            , corners: 1                    // Corner roundness (0..1)
            , color: '#000'                 // #rgb or #rrggbb or array of colors
            , opacity: 0.25                 // Opacity of the lines
            , rotate: 0                     // The rotation offset
            , direction: 1                  // 1: clockwise, -1: counterclockwise
            , speed: 1                      // Rounds per second
            , trail: 60                     // Afterglow percentage
            , fps: 20                       // Frames per second when using setTimeout() as a fallback for CSS
            , zIndex: 2e9                   // The z-index (defaults to 2000000000)
            , className: 'spinner'          // The CSS class to assign to the spinner
            , top: '50%'                    // Top position relative to parent
            , left: '50%'                   // Left position relative to parent
            , shadow: true                  // Whether to render a shadow
            , hwaccel: false                // Whether to use hardware acceleration
            , position: 'absolute'          // Element positioning
        }


        $(document).ready(function(){
            // $.ajaxSettings.async = false;

            // initialize info collector
            initUnit();
            initDuty();
            initEducation();
            initDomain();
            initOperation();

            initExpertList();




            // 监听表格点击事件
            $('#expertList tbody').on( 'click', 'tr', function () {
                // 单选为修改模式
                if (isMultisel == false) {
                    expertList.$('tr.selected').removeClass('selected');
                    // $(this).addClass('selected');
                    $(this).toggleClass('selected');
                    refillForm();
                }
                // 多选为删除模式
                else {
                    $(this).toggleClass('selected');
                }
            })



        })

        // 初始化单位列表
        function initUnit(){
            unitCombobox = $('#unit').magicSuggest({
                displayField: 'unit',
                valueField: 'id',
                toggleOnClick: true,
                resultAsString: true,
                sortOrder: 'id',
                maxDropHeight: 145,
                autoSelect: true,
                allowFreeEntries: true,
                useTabKey: true,
                useZebraStyle: true,
                maxSelection: 1,
                placeholder: " "
            });
            url = host+":"+port + "/operation/PullComboInfo";
            $.getJSON(url,{'type':'unit'},function(data){
                /* data structure
                {
                    'id':1,
                    'unit':'南京邮电大学'
                }
                data structure END */
                unitCombobox.setData(data);
                // unitCombobox.setValue([1]);
            });
        }

        // 初始化职务列表
        function initDuty(){
            dutyCombobox = $('#duty').magicSuggest({
                displayField: 'duty',
                valueField: 'id',
                toggleOnClick: true,
                resultAsString: true,
                sortOrder: 'id',
                maxDropHeight: 145,
                autoSelect: true,
                allowFreeEntries: true,
                useTabKey: true,
                useZebraStyle: true,
                maxSelection: 1,
                placeholder: " "
            });
            url = host+":"+port + "/operation/PullComboInfo";
            $.getJSON(url,{'type':'duty'},function(data){
                /* data structure
                {
                    'id':1,
                    'duty':'教授'
                }
                data structure END */
                dutyCombobox.setData(data);
                // dutyCombobox.setValue([1]);
            });
        }

        // 初始化学位列表
        function initEducation(){
            educationCombobox = $('#education').magicSuggest({
                displayField: 'education',
                valueField: 'id',
                toggleOnClick: true,
                resultAsString: true,
                sortOrder: 'id',
                maxDropHeight: 145,
                autoSelect: true,
                allowFreeEntries: true,
                useTabKey: true,
                useZebraStyle: true,
                maxSelection: 1,
                placeholder: " "
            });
            url = host+":"+port + "/operation/PullComboInfo";
            $.getJSON(url,{'type':'education'},function(data){
                /* data structure
                {
                    'id':1,
                    'education':'博士'
                }
                data structure END */
                educationCombobox.setData(data);
                // educationCombobox.setValue([1]);
            });
        }

        // 初始化专业列表
        function initDomain(){
            domainCombobox = $('#domain').magicSuggest({
                displayField: 'domain',
                valueField: 'id',
                toggleOnClick: true,
                resultAsString: true,
                sortOrder: 'id',
                maxDropHeight: 145,
                autoSelect: true,
                allowFreeEntries: true,
                useTabKey: true,
                useZebraStyle: true,
                maxSelection: 1,
                placeholder: " "
            });
            url = host+":"+port + "/operation/PullComboInfo";
            $.getJSON(url,{'type':'domain'},function(data){
                /* data structure
                {
                    'id':1,
                    'domain':'新能源'
                }
                data structure END */
                domainCombobox.setData(data);
                // domainCombobox.setValue([1]);
            });
        }

        // 初始化操作类型列表
        function initOperation(){
            operationCombobox = $('#operation').magicSuggest({
                data: [{'id':1,'name':'新增'}],
                displayField: 'name',
                valueField: 'id',
                toggleOnClick: true,
                resultAsString: true,
                sortOrder: 'id',
                maxDropHeight: 145,
                value: [1],
                autoSelect: true,
                allowFreeEntries: true,
                useTabKey: true,
                useZebraStyle: true,
                maxSelection: 1,
            });
        }

        // 将要修改的记录填到输入框中
        function refillForm(){
            var datum = expertList.rows('.selected').data()[0];
            record_id = datum[0];
            $("#name").val(datum[1]);
            $("#code").val(datum[2]);
            $("#phone").val(datum[3]);
            $("#email").val(datum[4]);
            unitCombobox.clear();
            unitCombobox.setValue([datum[5]]);
            dutyCombobox.clear();
            dutyCombobox.setValue([datum[6]]);
            educationCombobox.clear();
            educationCombobox.setValue([datum[7]]);
            domainCombobox.clear();
            domainCombobox.setValue([datum[8]]);
            operationCombobox.clear();
            operationCombobox.setValue(['修改']);
            $("#remark").val(datum[9]);
        }

        // 清空并初始化输入框
        function clearForm(){
            record_id = 0;
            $("#name").val('');
            $("#code").val('');
            $("#phone").val('');
            $("#email").val('');
            unitCombobox.clear();
            initUnit();
            dutyCombobox.clear();
            initDuty();
            educationCombobox.clear();
            initEducation();
            domainCombobox.clear();
            initDomain();
            operationCombobox.clear();
            operationCombobox.setValue(['新增']);
            $("#remark").val('');
        }

        function insertCorrectDatum(){
            // 整合提交数据
            datum = {
                'name':$("#name").val(),
                'code':$("#code").val(),
                'phone':$("#phone").val(),
                'email':$("#email").val(),
                'unit':(unitCombobox.getSelection().length!=0)?unitCombobox.getSelection()[0].unit:'无',
                'duty':(dutyCombobox.getSelection().length!=0)?dutyCombobox.getSelection()[0].duty:'无',
                'education':(educationCombobox.getSelection().length!=0)?educationCombobox.getSelection()[0].education:'无',
                'domain':(domainCombobox.getSelection().length!=0)?domainCombobox.getSelection()[0].domain:'无',
                'remark':($("#remark").val()!="")?$("#remark").val():'无'
            };

            // 新增一条记录的操作
            if (operationCombobox.getSelection()[0].name == '新增') {
                url = host+":"+port + "/operation/InsertDatum";
                $.ajax({
                    url: url,
                    type: 'post',
                    data: JSON.stringify(datum),
                    dataType: 'JSON',
                    async: false,
                    cache: false,
                    contentType: 'application/x-www-form-urlencoded',
                    processData: true,  
                    success: function (data) {
                        if (data.msg == 'OK') {
                            expertList.destroy();
                            initExpertList();
                            alert("新增记录成功！");
                            clearForm();
                        }
                        else {
                            alert("新增记录失败! 错误信息: " + data.msg);
                        }
                    } 
                })
            }
            // 修改一条记录的操作
            else if (operationCombobox.getSelection()[0].name == '修改') {
                datum.id = record_id;
                url = host+":"+port + "/operation/CorrectDatum";
                $.ajax({
                    url: url,
                    type: 'post',
                    data: JSON.stringify(datum),
                    dataType: 'JSON',
                    async: false,
                    cache: false,
                    contentType: 'application/x-www-form-urlencoded',
                    processData: true,  
                    success: function (data) {
                        if (data.msg == 'OK') {
                            expertList.destroy();
                            initExpertList();
                            alert("修改记录成功！");
                            clearForm();
                        }
                        else {
                            alert("修改记录失败! 错误信息: " + data.msg);
                        }
                    } 
                })
            }
            // 如果不是新增也不是修改，那么说明走错了通道
            else {
                alert("请选择正确的操作类型（”新增“或”修改“）");
            }

            loadingSignStop();
        }

        // ”刷新列表“事务
        $("#RefreshTable").click(function(){
            expertList.destroy();
            initExpertList();
        })

        // "提交"事务
        $("#Submit").click(function(){
            // check all inputs
            if ($('#name').val().length == 0) {
                alert('请输入姓名！');
            }
            else if ($('#code').val().length == 0) {
                alert('请输入身份证号！');
            }
            else if (unitCombobox.getValue().length == 0) {
                alert('请输入单位信息！');
            }
            else if (operationCombobox.getValue().length == 0) {
                alert('请选择操作类型！');
            }
            else{
                // loading sign
                loadingSign();
                insertCorrectDatum();
            }
        })

        // ”多选“按钮事务
        $("#multi-select").click(function(){
            isMultisel = !isMultisel;
            if (isMultisel) {
                $(this).addClass("active");
                $(this).text("取消多选");
                expertList.$('tr.selected').removeClass('selected');
            }
            else{
                $(this).removeClass("active");
                $(this).text("多选");
                expertList.$('tr.selected').removeClass('selected');
            }
        })



        // ”删除“按钮事务
        $("#delete").click(function(){
            if (expertList.rows('.selected').data().length == 0) {
                alert("请选择删除条目！");
            }
            else {
                var se=confirm("删除"+ expertList.rows('.selected').data().length +"条记录?");
                if (se==true){
                    $("#multi-select").removeClass("active");
                    $("#multi-select").text("多选");


                    record_id = new Array();
                    for (var i = 0; i < expertList.rows('.selected').data().length; i++) {
                        record_id[i] = expertList.rows('.selected').data()[i][0];
                    }
                    datum = {'record_id':record_id}
                    url = host+":"+port + "/operation/DeleteDatum";
                    $.ajax({
                        url: url,
                        type: 'post',
                        data: JSON.stringify(record_id),
                        dataType: 'JSON',
                        async: false,
                        cache: false,
                        contentType: 'application/x-www-form-urlencoded',
                        processData: true,  
                        success: function (data) {
                            if (data.msg == 'OK') {
                                expertList.destroy();
                                initExpertList();
                                alert("删除记录成功！");
                            }
                            else {
                                alert("删除记录失败! 错误信息: " + data.msg);
                            }
                        } 
                    })
                }
            }  
        })



        // 初始化专家信息列表
        function initExpertList(){
            expertList = $('#expertList').DataTable( {
                "processing": true,
                "serverSide": true,
                "scrollX": true,
                "searchDelay": 1000,
                "columns": [
                    {"data":0, "name":"id", "visible":false, "searchable":false},
                    {"data":1, "name":"name"},
                    {"data":2, "name":"code"},
                    {"data":3, "name":"phone"},
                    {"data":4, "name":"email"},
                    {"data":5, "name":"unit"},
                    {"data":6, "name":"duty"},
                    {"data":7, "name":"education"},
                    {"data":8, "name":"domain"},
                    {"data":9, "name":"remark"}
                ],
                "ajax": $.fn.dataTable.pipeline({
                    url: host+":"+port+"/operation/ShowExpertList",
                    pages: 1 // number of pages to cache
                })
            });
        }

        // Register an API method that will empty the pipelined data, forcing an Ajax
        // fetch on the next draw (i.e. `table.clearPipeline().draw()`)
        $.fn.dataTable.Api.register('clearPipeline()', function(){
            return this.iterator('table', function (settings) {
                settings.clearCache = true;
            });
        })

        //
        // Pipelining function for DataTables. To be used to the `ajax` option of DataTables
        //
        $.fn.dataTable.pipeline = function (opts) {
            // Configuration options
            var conf = $.extend( {
                pages: 5,     // number of pages to cache
                url: '',      // script url
                data: null,   // function or object with parameters to send to the server
                              // matching how `ajax.data` works in DataTables
                method: 'POST' // Ajax HTTP method
            }, opts );

            // Private variables for storing the cache
            var cacheLower = -1;
            var cacheUpper = null;
            var cacheLastRequest = null;
            var cacheLastJson = null;
         
            return function (request, drawCallback, settings) {

                // redefine the format of request
                for (var i = 0; i < request.columns.length; i++) {
                    delete request.columns[i].search;
                };


                var ajax          = false;
                var requestStart  = request.start;
                var drawStart     = request.start;
                var requestLength = request.length;
                var requestEnd    = requestStart + requestLength;
                 
                if (settings.clearCache){
                    // API requested that the cache be cleared
                    ajax = true;
                    settings.clearCache = false;
                }
                else if ( cacheLower < 0 || requestStart < cacheLower || requestEnd > cacheUpper ) {
                    // outside cached data - need to make a request
                    ajax = true;
                }
                else if ( JSON.stringify( request.order )   !== JSON.stringify( cacheLastRequest.order ) ||
                          JSON.stringify( request.columns ) !== JSON.stringify( cacheLastRequest.columns ) ||
                          JSON.stringify( request.search )  !== JSON.stringify( cacheLastRequest.search )
                ){
                    // properties changed (ordering, columns, searching)
                    ajax = true;
                }
                 
                // Store the request for checking next time around
                cacheLastRequest = $.extend( true, {}, request );
         
                if (ajax){
                    // Need data from the server
                    if ( requestStart < cacheLower ) {
                        requestStart = requestStart - (requestLength*(conf.pages-1));
         
                        if ( requestStart < 0 ) {
                            requestStart = 0;
                        }
                    }
                     
                    cacheLower = requestStart;
                    cacheUpper = requestStart + (requestLength * conf.pages);
         
                    request.start = requestStart;
                    request.length = requestLength*conf.pages;
         
                    // Provide the same `data` options as DataTables.
                    if ($.isFunction (conf.data)){
                        // As a function it is executed with the data object as an arg
                        // for manipulation. If an object is returned, it is used as the
                        // data object to submit
                        var d = conf.data( request );
                        if ( d ) {
                            $.extend( request, d );
                        }
                    }
                    else if ( $.isPlainObject(conf.data) ) {
                        // As an object, the data given extends the default
                        $.extend(request, conf.data);
                    }

                    settings.jqXHR = $.ajax({
                        "type":     conf.method,
                        "url":      conf.url,
                        "data":     JSON.stringify(request),
                        "dataType": "json",
                        "cache":    false,
                        "contentType": 'application/x-www-form-urlencoded',
                        "processData": true,
                        "success":  function (json) {
                            cacheLastJson = $.extend(true, {}, json);
                            
                            if (cacheLower != drawStart){
                                json.data.splice(0, drawStart-cacheLower);
                            }
                            if (requestLength >= -1) {
                                json.data.splice(requestLength, json.data.length);
                            }
                            
                            drawCallback(json);

                        }
                    })
                }
                else {
                    json = $.extend(true, {}, cacheLastJson);
                    json.draw = request.draw; // Update the echo for each response
                    json.data.splice(0, requestStart-cacheLower);
                    json.data.splice(requestLength, json.data.length);
                    
                    drawCallback(json);
                }
            }
        }

        function loadingSign(){
            var target = document.getElementById('ControlPanel');
            spinner = new Spinner(opts).spin(target);
            $("#ControlPanel *").prop('disabled',true);
        }

        function loadingSignStop(){
            $("#ControlPanel *").prop('disabled',false);
            if (typeof spinner != 'undefined') {
                spinner.stop();
            };
        }



    </script>

</body>

</html>
